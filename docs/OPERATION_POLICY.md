# OPERATION_POLICY.md

본 문서는 EMS에서 사용하는 **운전 판단 기준(Operation Policy)** 을 정의한다.  
본 정책은 각 장비의 상태 모델(Device Status Model) 결과를 기반으로  
**충·방전 가능 여부 / 운전 정지 조건**을 판단하는 상위 기준 문서이다.

- UI_CONTRACT.md와 충돌 시, **OPERATION_POLICY.md가 우선**한다.
- 상태 해석과 운전 판단은 **절대 혼합하지 않는다**.

---

## 1. 적용 범위

본 정책은 다음 대상에 적용된다.

- 배터리 충·방전 운전 판단
- 환경 조건(온습도) 기반 운전 제한
- Scheduler 제어 실행 판단 기준

---

## 2. 운전 판단 책임 분리 (중요)

| 계층 | 책임 |
|---|---|
| Provider | Raw 데이터 제공 |
| Device Status Model | 상태 해석 (정상 / 고온 / 저온 / 과습 / 통신단절) |
| Operation Policy | **운전 가능 / 운전 정지 판단** |
| Scheduler | 정책 결과에 따른 제어 실행 |
| UI | 결과 표현만 수행 |

⚠️ **상태 판단과 운전 판단은 절대 혼합하지 않는다**

---

## 3. 온습도 기반 충·방전 운전 정책

### 3.1 입력 모델

온습도 운전 판단은 다음 View DTO를 입력으로 사용한다.

- `TemperatureHumidityStatusTableViewDto`
    - `overallStatus`
    - `operable`
    - `tempMin`
    - `tempMax`
    - `humidityMax`

---

### 3.2 판단 대상 환경

- 배터리 룸 온도
- 배터리 룸 습도
- 온습도계 채널 통신 상태 (다중 채널)

---

### 3.3 충·방전 **즉시 정지 조건** (Fail-Safe)

다음 조건 중 **하나라도 만족하면 즉시 충·방전 운전 정지**한다.

#### ① 환경 정보 수신 불가
- 모든 온습도 채널 통신 불가
- 배터리 룸 환경 상태 판단 불가

#### ② 온도 기준 이탈
- 하나라도 아래 조건 만족 시
    - 온도 < 기준온도Min
    - 온도 > 기준온도Max

#### ③ 습도 기준 초과
- 하나라도 아래 조건 만족 시
    - 습도 > 기준습도Max

> 채널 수와 무관하며  
> **단 하나의 채널이라도 기준을 벗어나면 즉시 정지**한다.

---

### 3.4 충·방전 **운전 가능 조건**

다음 조건을 **모두 만족해야 함**

- 하나 이상의 온습도 채널 통신 정상
- 모든 정상 채널이 기준 범위 내
- `operable = true`

---

### 3.5 다중 채널 통신 정책

| 상태 | 의미 |
|---|---|
| 일부 채널 통신 단절 | **운전 가능 판단 유지** |
| 전체 채널 통신 단절 | **운전 정지 (Fail-Safe)** |

> 배터리 룸 환경은  
> **하나의 정상 채널만 있어도 판단 가능**하다고 간주한다.

---

## 4. 온습도 상태 해석 기준 (Device Model)

### 4.1 채널 단위 상태 정의

| 상태 | 의미 |
|---|---|
| NORMAL | 기준 범위 내 |
| HIGH_TEMP | 고온 |
| LOW_TEMP | 저온 |
| HIGH_HUMIDITY | 과습 |
| DISCONNECTED | 통신 단절 |

> `WARNING`은 **표현용 상태가 아니라 상위 분류 상태**이며  
> UI에서는 반드시 **원인 명칭으로 치환**한다.

---

### 4.2 UI 상태 문구 매핑 규칙

| 내부 상태 | UI 표시 |
|---|---|
| HIGH_TEMP | 고온 |
| LOW_TEMP | 저온 |
| HIGH_HUMIDITY | 과습 |
| DISCONNECTED | 통신 단절 |
| NORMAL | 정상 |

❌ “주의” 단독 사용 금지  
⭕ 반드시 **원인 기반 표현 사용**

---

## 5. 대표 온습도 값 표시 정책

상단 요약 카드에는 다음 기준으로 대표 값을 표시한다.

| 항목 | 기준 |
|---|---|
| 대표 온도 | **최대 온도(tempMax)** |
| 대표 습도 | **최대 습도(humidityMax)** |

> 위험 판단 기준은 **항상 최악 조건(Worst Case)** 을 사용한다.

---

## 6. 운전 판단 결과 정의

| operable | 의미 |
|---|---|
| true | 충·방전 운전 가능 |
| false | 충·방전 운전 정지 |

Scheduler / UI / 제어 로직은  
**operable 값만을 기준으로 판단**한다.

---

## 7. UI 표현 원칙

- 운전 상태 문구는 반드시 아래 중 하나만 사용
    - **충방전 운전가능**
    - **충방전 운전정지**

- 정지 사유는:
    - Device Status Model 결과로 표현
    - Operation Policy는 사유를 설명하지 않는다

---

## 8. 에어컨 상태와의 관계 (중요)

- 에어컨 상태는 **충·방전 판단의 직접 조건이 아니다**
- 에어컨 고장 / MANUAL / 통신 불가는
    - **충·방전 정지 조건 아님**
- 단,
    - 에어컨 문제로 인해
    - 실제 온습도 값이 기준 이탈 시
    - **온습도 정책에 의해 충·방전 정지**

---

## 9. Fail-Safe 원칙 요약

| 상황 | 판단 |
|---|---|
| 환경 판단 불가 | 정지 |
| 환경 이상 | 정지 |
| 정상 판단 가능 | 허용 |

> **안전 판단 불가능 = 운전 불가**

---

## 10. 변경 이력

### v1.1 (2026-01-03)
- 온습도 다중 채널 운전 정책 확정
- 단일 채널 기준 이탈 시 즉시 정지 규칙 명문화
- “주의” 표현 제거 → 고온 / 저온 / 과습 명확화
- 대표 온습도 값 Worst Case 기준 확정
- operable 단일 운전 판단 기준 확정

---

## Related Documents

- ENVIRONMENT_POLICY.md
- DEVICE_STATUS_MODEL.md
- UI_STATUS_COLOR_POLICY.md
- SCHEDULER_POLICY.md

---
